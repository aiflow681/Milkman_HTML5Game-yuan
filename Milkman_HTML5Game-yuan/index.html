<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    
    <title>MILKMAN - ç‰›å¥¶äºº</title>

    <link href="css/stylesheet.css" rel="stylesheet" />
    
    <style>
        /* ç§»åŠ¨ç«¯ä¼˜åŒ–æ ·å¼ */
        * {
            box-sizing: border-box;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            touch-action: manipulation;
            font-family: Arial, sans-serif;
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #1a1a1a;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            height: calc(100vh - 140px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        canvas {
            max-width: 100%;
            max-height: 100%;
            image-rendering: pixelated;
            image-rendering: -moz-crisp-edges;
            image-rendering: crisp-edges;
        }

        /* è™šæ‹Ÿæ§åˆ¶å™¨ */
        .virtual-controls {
            position: fixed;
            bottom: 20px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            pointer-events: none;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: all;
        }

        .movement-controls {
            flex-direction: row;
        }

        .control-button {
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.4);
            border-radius: 10px;
            color: white;
            font-size: 16px;
            font-weight: bold;
            padding: 15px 20px;
            min-width: 60px;
            min-height: 60px;
            cursor: pointer;
            backdrop-filter: blur(10px);
            transition: all 0.1s ease;
            touch-action: manipulation;
        }

        .control-button:active {
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0.95);
        }

        .control-button.jump {
            background: rgba(255, 200, 0, 0.3);
            border-color: rgba(255, 200, 0, 0.6);
            min-width: 80px;
        }

        .control-button.jump:active {
            background: rgba(255, 200, 0, 0.5);
        }

        /* æ¸¸æˆçŠ¶æ€æ˜¾ç¤º */
        .game-status {
            position: fixed;
            top: 20px;
            left: 20px;
            color: white;
            font-size: 18px;
            font-weight: bold;
            z-index: 1000;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.8);
        }

        .game-help {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0,0,0,0.7);
            color: white;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
            z-index: 1000;
            max-width: 200px;
        }

        /* ç§»åŠ¨ç«¯éšè—å…ƒç´  */
        @media (min-width: 768px) {
            .virtual-controls {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="game-container">
        <div class="game-status" id="gameStatus">
            åˆ†æ•°: <span id="score">0</span> | æ—¶é—´: <span id="time">0</span>
        </div>
        
        <div class="game-help">
            ğŸƒâ€â™‚ï¸ ç§»åŠ¨<br>
            â¬†ï¸ è·³è·ƒ<br>
            ğŸ“± è§¦æ‘¸æ§åˆ¶
        </div>

        <div class="canvas-wrapper">
            <canvas id="bg-canvas" width="768" height="600"></canvas>
            <canvas id="fg-canvas" width="768" height="600"></canvas>
        </div>

        <!-- è™šæ‹Ÿæ§åˆ¶å™¨ -->
        <div class="virtual-controls">
            <div class="control-group movement-controls">
                <button class="control-button" id="leftBtn">â¬…ï¸</button>
                <button class="control-button" id="rightBtn">â¡ï¸</button>
            </div>
            
            <div class="control-group">
                <button class="control-button jump" id="jumpBtn">â¬†ï¸</button>
            </div>
        </div>
    </div>

    <script src="js/jquery.min.js"></script>
    <script src="js/input.js"></script>
    <script src="js/entities.js"></script>
    <script src="js/render.js"></script>
    <script src="js/animation.js"></script>
    <script src="js/physics.js"></script>
    <script src="js/movement.js"></script>
    <script src="js/game.js"></script>

    
    <!-- ç§»åŠ¨ç«¯ä¼˜åŒ–è„šæœ¬ -->
    <script>
        // ç§»åŠ¨ç«¯æ¸¸æˆä¼˜åŒ–
        function initMobileGame() {
            // è®¾ç½®Canvasè‡ªé€‚åº”
            setupResponsiveCanvas();
            
            // åˆå§‹åŒ–è™šæ‹Ÿæ§åˆ¶å™¨
            initVirtualControls();
            
            // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
            optimizeMobilePerformance();
            
            // ç¦ç”¨é¡µé¢æ»šåŠ¨
            disablePageScroll();
            
            // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
            initGameStatus();
            
            // åˆå§‹åŒ–å…¨å±åŠŸèƒ½
            if (window.FullscreenUtils) {
                FullscreenUtils.initFullscreen('bg-canvas', 'ç‰›å¥¶äºº');
            }
        }

        // è®¾ç½®å“åº”å¼Canvas
        function setupResponsiveCanvas() {
            const bgCanvas = document.getElementById('bg-canvas');
            const fgCanvas = document.getElementById('fg-canvas');
            const canvasWrapper = document.querySelector('.canvas-wrapper');
            
            function resizeCanvas() {
                const containerWidth = canvasWrapper.clientWidth;
                const containerHeight = canvasWrapper.clientHeight;
                
                // ä¿æŒå®½é«˜æ¯” 768:600 = 1.28
                const aspectRatio = 768 / 600;
                let canvasWidth = containerWidth;
                let canvasHeight = canvasWidth / aspectRatio;
                
                if (canvasHeight > containerHeight) {
                    canvasHeight = containerHeight;
                    canvasWidth = canvasHeight * aspectRatio;
                }
                
                bgCanvas.style.width = canvasWidth + 'px';
                bgCanvas.style.height = canvasHeight + 'px';
                fgCanvas.style.width = canvasWidth + 'px';
                fgCanvas.style.height = canvasHeight + 'px';
            }
            
            window.addEventListener('resize', resizeCanvas);
            window.addEventListener('orientationchange', () => {
                setTimeout(resizeCanvas, 100);
            });
            
            resizeCanvas();
        }

        // åˆå§‹åŒ–è™šæ‹Ÿæ§åˆ¶å™¨
        function initVirtualControls() {
            const leftBtn = document.getElementById('leftBtn');
            const rightBtn = document.getElementById('rightBtn');
            const jumpBtn = document.getElementById('jumpBtn');

            // è§¦æ‘¸äº‹ä»¶å¤„ç†
            function setupButton(button, keyCode) {
                let isPressed = false;
                
                // Touch events
                button.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    if (!isPressed) {
                        simulateKeyPress(keyCode);
                        isPressed = true;
                        button.classList.add('active');
                    }
                });
                
                button.addEventListener('touchend', (e) => {
                    e.preventDefault();
                    simulateKeyRelease(keyCode);
                    isPressed = false;
                    button.classList.remove('active');
                });
                
                button.addEventListener('touchcancel', (e) => {
                    e.preventDefault();
                    simulateKeyRelease(keyCode);
                    isPressed = false;
                    button.classList.remove('active');
                });
                
                // Mouse events for testing
                button.addEventListener('mousedown', (e) => {
                    e.preventDefault();
                    if (!isPressed) {
                        simulateKeyPress(keyCode);
                        isPressed = true;
                        button.classList.add('active');
                    }
                });
                
                button.addEventListener('mouseup', (e) => {
                    e.preventDefault();
                    simulateKeyRelease(keyCode);
                    isPressed = false;
                    button.classList.remove('active');
                });
                
                button.addEventListener('mouseleave', (e) => {
                    if (isPressed) {
                        simulateKeyRelease(keyCode);
                        isPressed = false;
                        button.classList.remove('active');
                    }
                });
            }

            setupButton(leftBtn, 37);  // å·¦ç®­å¤´
            setupButton(rightBtn, 39); // å³ç®­å¤´
            setupButton(jumpBtn, 38);  // ä¸Šç®­å¤´
        }

        // æ¨¡æ‹ŸæŒ‰é”®æŒ‰ä¸‹
        function simulateKeyPress(keyCode) {
            const event = new KeyboardEvent('keydown', {
                keyCode: keyCode,
                which: keyCode,
                bubbles: true
            });
            document.dispatchEvent(event);
        }

        // æ¨¡æ‹ŸæŒ‰é”®é‡Šæ”¾
        function simulateKeyRelease(keyCode) {
            const event = new KeyboardEvent('keyup', {
                keyCode: keyCode,
                which: keyCode,
                bubbles: true
            });
            document.dispatchEvent(event);
        }

        // ç§»åŠ¨ç«¯æ€§èƒ½ä¼˜åŒ–
        function optimizeMobilePerformance() {
            // ç¦ç”¨é¡µé¢æ»šåŠ¨
            document.addEventListener('touchmove', (e) => {
                e.preventDefault();
            }, { passive: false });
            
            // ä¼˜åŒ–æ¸²æŸ“
            if (window.devicePixelRatio > 2) {
                // é«˜DPIè®¾å¤‡ä¼˜åŒ–
                const canvas = document.getElementById('bg-canvas');
                const ctx = canvas.getContext('2d');
                ctx.imageSmoothingEnabled = false;
            }
        }

        // ç¦ç”¨é¡µé¢æ»šåŠ¨
        function disablePageScroll() {
            document.body.style.overflow = 'hidden';
            document.documentElement.style.overflow = 'hidden';
        }

        // åˆå§‹åŒ–æ¸¸æˆçŠ¶æ€æ˜¾ç¤º
        function initGameStatus() {
            // å°è¯•ä»åŸæ¸¸æˆè·å–çŠ¶æ€
            const originalStatus = document.getElementById('status');
            if (originalStatus) {
                originalStatus.style.display = 'none';
            }
            
            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            setInterval(() => {
                const timeElement = document.getElementById('time');
                if (timeElement) {
                    // ä½¿ç”¨æ›´å®‰å…¨çš„æ–¹å¼è·å–æ—¶é—´
                    try {
                        const statusElement = document.querySelector('h2#status');
                        let timeValue = '0';
                        
                        if (statusElement) {
                            const statusText = statusElement.textContent || '';
                            const timeMatch = statusText.match(/\|(\s*\d+)/);
                            if (timeMatch && timeMatch[1]) {
                                timeValue = timeMatch[1].trim();
                            }
                        }
                        
                        timeElement.textContent = timeValue;
                    } catch (e) {
                        // é”™è¯¯å¤„ç†ï¼Œç¡®ä¿å³ä½¿è·å–çŠ¶æ€å¤±è´¥ï¼Œæ¸¸æˆä»ç„¶å¯ä»¥è¿è¡Œ
                        console.error('Error getting game status:', e);
                    }
                }
            }, 1000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', initMobileGame);
        
        // å¦‚æœDOMå·²ç»åŠ è½½å®Œæˆï¼Œç›´æ¥åˆå§‹åŒ–
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initMobileGame);
        } else {
            initMobileGame();
        }
    </script>
</body>

</html>
